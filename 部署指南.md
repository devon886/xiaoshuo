# 🚀 小说网站完整部署指南

## 📋 部署概览

您的项目是一个全栈小说网站，包含：
- **后端**: Node.js + Express + Socket.io API
- **前端**: Vue.js + TypeScript + Element Plus 
- **数据库**: MongoDB
- **特色功能**: 实时协作编辑、用户认证、小说管理

## 🎯 部署方式选择

### 方案1: 传统云服务器部署 (推荐)
适合：中小型项目，需要完全控制
平台：阿里云、腾讯云、华为云、AWS等

### 方案2: 容器化部署 (Docker)
适合：团队开发，易于扩展
平台：任何支持Docker的环境

### 方案3: Serverless部署
适合：流量不稳定的项目
平台：Vercel、Netlify等

---

## 🌟 方案1: 云服务器部署 (详细教程)

### 第一步: 服务器准备

#### 1.1 购买云服务器
**推荐配置**:
- CPU: 2核心以上
- 内存: 4GB以上
- 存储: 40GB以上
- 操作系统: Ubuntu 20.04 LTS 或 CentOS 8

#### 1.2 连接服务器
```bash
# 使用SSH连接
ssh root@your-server-ip
```

#### 1.3 安装基础环境
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js (推荐使用NodeSource)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version  # 应该显示 v18.x.x
npm --version

# 安装PM2 (进程管理器)
sudo npm install -g pm2

# 安装Git
sudo apt install git -y
```

### 第二步: MongoDB数据库配置

#### 2.1 安装MongoDB
```bash
# 导入公钥
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -

# 添加MongoDB源
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list

# 安装MongoDB
sudo apt-get update
sudo apt-get install -y mongodb-org

# 启动MongoDB服务
sudo systemctl start mongod
sudo systemctl enable mongod

# 验证安装
sudo systemctl status mongod
```

#### 2.2 配置MongoDB安全性
```bash
# 进入MongoDB Shell
mongosh

# 创建管理员用户
use admin
db.createUser({
  user: "admin",
  pwd: "your-strong-password",
  roles: [{ role: "userAdminAnyDatabase", db: "admin" }]
})

# 创建应用数据库用户
use novel-website
db.createUser({
  user: "novel-user",
  pwd: "your-app-password", 
  roles: [{ role: "readWrite", db: "novel-website" }]
})

exit
```

#### 2.3 启用MongoDB认证
```bash
# 编辑配置文件
sudo nano /etc/mongod.conf

# 添加以下配置
security:
  authorization: enabled

# 重启MongoDB
sudo systemctl restart mongod
```

### 第三步: 部署应用代码

#### 3.1 上传代码
```bash
# 方法1: 使用Git (推荐)
cd /home
git clone https://your-git-repository.git novel-website
cd novel-website

# 方法2: 使用SCP上传
# 在本地执行:
# scp -r /path/to/your/project root@your-server-ip:/home/novel-website
```

#### 3.2 安装依赖
```bash
cd /home/novel-website
npm install --production
```

#### 3.3 配置环境变量
```bash
# 创建生产环境配置
nano .env
```

添加以下内容:
```env
# 基础配置
NODE_ENV=production
PORT=5000

# 数据库配置
MONGO_URI=mongodb://novel-user:your-app-password@localhost:27017/novel-website

# JWT密钥 (请生成一个强密钥)
JWT_SECRET=your-super-secure-jwt-secret-key-here

# 其他配置
CORS_ORIGIN=https://your-domain.com
```

### 第四步: 前端构建

#### 4.1 创建前端构建配置
```bash
# 创建前端package.json
cat > frontend-package.json << 'EOF'
{
  "name": "novel-website-frontend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "vue": "^3.3.4",
    "vue-router": "^4.2.4",
    "pinia": "^2.1.6",
    "element-plus": "^2.3.8",
    "axios": "^1.4.0",
    "socket.io-client": "^4.7.2",
    "vue-toastification": "^2.0.0-rc.5"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^4.2.3",
    "vite": "^4.4.5",
    "typescript": "^5.0.2"
  }
}
EOF
```

#### 4.2 创建Vite配置
```bash
cat > vite.config.ts << 'EOF'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    minify: 'terser',
    rollupOptions: {
      input: {
        main: 'index.html'
      }
    }
  },
  server: {
    proxy: {
      '/api': 'http://localhost:5000'
    }
  }
})
EOF
```

#### 4.3 安装前端依赖并构建
```bash
# 使用前端package.json安装依赖
cp frontend-package.json package-frontend.json
npm install --prefix . --package-lock-only

# 构建前端
npx vite build
```

### 第五步: 配置进程管理

#### 5.1 创建PM2配置文件
```bash
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'novel-website',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development'
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 5000
    },
    log_file: './logs/app.log',
    error_file: './logs/error.log',
    out_file: './logs/out.log',
    max_memory_restart: '500M',
    watch: false,
    ignore_watch: ['node_modules', 'logs']
  }]
}
EOF
```

#### 5.2 创建日志目录并启动应用
```bash
# 创建日志目录
mkdir -p logs

# 启动应用
pm2 start ecosystem.config.js --env production

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
```

### 第六步: 配置Nginx反向代理

#### 6.1 安装Nginx
```bash
sudo apt install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 6.2 配置Nginx
```bash
sudo nano /etc/nginx/sites-available/novel-website
```

添加以下配置:
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 静态文件缓存
    location /assets/ {
        root /home/novel-website/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Socket.io支持
    location /socket.io/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 前端应用
    location / {
        root /home/novel-website/dist;
        try_files $uri $uri/ /index.html;
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
    }
}
```

#### 6.3 启用站点
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/novel-website /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 第七步: SSL证书配置

#### 7.1 安装Certbot
```bash
sudo apt install certbot python3-certbot-nginx -y
```

#### 7.2 获取SSL证书
```bash
# 自动配置SSL
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo systemctl enable certbot.timer
```

### 第八步: 防火墙配置

```bash
# 配置UFW防火墙
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

---

## 🐳 方案2: Docker容器化部署

### 创建Dockerfile
```dockerfile
# 后端Dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制依赖文件
COPY package*.json ./
RUN npm ci --only=production

# 复制应用代码
COPY . .

# 构建前端 (如果需要)
RUN npm run build:frontend || true

EXPOSE 5000

CMD ["npm", "start"]
```

### 创建docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - MONGO_URI=mongodb://mongo:27017/novel-website
      - JWT_SECRET=your-jwt-secret
    depends_on:
      - mongo
    volumes:
      - ./logs:/app/logs

  mongo:
    image: mongo:6.0
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
    volumes:
      - mongo_data:/data/db

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app

volumes:
  mongo_data:
```

### 部署命令
```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f
```

---

## 🔧 生产环境优化

### 性能优化
```bash
# 启用gzip压缩 (在Nginx配置中)
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

# 设置文件上传限制
client_max_body_size 10M;
```

### 监控配置
```bash
# 安装监控工具
npm install -g @pm2/web

# 启动监控界面
pm2 web
```

### 日志管理
```bash
# 配置日志轮转
sudo nano /etc/logrotate.d/novel-website

# 添加配置
/home/novel-website/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
}
```

## 📝 部署检查清单

### 部署前检查
- [ ] 域名已解析到服务器IP
- [ ] 服务器安全组/防火墙已配置
- [ ] MongoDB数据库已安装并配置认证
- [ ] 环境变量已正确设置
- [ ] SSL证书已申请

### 部署后检查
- [ ] 应用正常启动 (`pm2 status`)
- [ ] 数据库连接正常
- [ ] API接口可以访问
- [ ] Socket.io连接正常
- [ ] 前端页面加载正常
- [ ] HTTPS重定向工作
- [ ] 日志记录正常

## 🆘 常见问题解决

### 问题1: MongoDB连接失败
```bash
# 检查MongoDB状态
sudo systemctl status mongod

# 查看MongoDB日志
sudo tail -f /var/log/mongodb/mongod.log

# 检查连接字符串格式
mongodb://username:password@host:port/database
```

### 问题2: PM2应用崩溃
```bash
# 查看错误日志
pm2 logs

# 重启应用
pm2 restart novel-website

# 检查内存使用
pm2 monit
```

### 问题3: Nginx 502错误
```bash
# 检查后端服务状态
pm2 status

# 检查Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

## 🚀 快速部署脚本

我可以为您创建一个自动化部署脚本，一键完成整个部署过程。需要吗？

---

**部署完成后，您的小说网站将具备**:
- ✅ 高可用性和负载均衡
- ✅ HTTPS安全连接
- ✅ 自动进程管理和重启
- ✅ 日志监控和轮转
- ✅ 数据库安全认证
- ✅ 静态资源优化缓存